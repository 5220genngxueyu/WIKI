<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jiava.wiki.mapper.DocMapperCust">
    
    <update id="increaseViewCount" >
        update doc set view_count = view_count+1 where id=#{id}
    </update>
    <update id="increaseVoteCount">
        update doc set vote_count = vote_count + 1 where id = #{id}
    </update>
    <update id="updateCount">
        update ebook t1,
            (select ebook_id ,count(*) doc_count,sum(view_count) view_count,sum(vote_count) vote_count from doc group by ebook_id) t2
        set t1.vote_count=t2.vote_count , t1.view_count=t2.view_count,t1.doc_count=t2.doc_count
        where t1.id=t2.ebook_id
    </update>
    <update id="dailyCount">
--         先从原来电子书把电子书表单拷过来
insert into ebook_snapshot (ebook_id, date, view_count, vote_count, view_increase, vote_increase)
        select t1.id, curdate(), 0, 0, 0, 0
        from ebook t1
        where not exists(select 1 from ebook_snapshot t2 where t1.id = t2.ebook_id and t2.date=curdate());


--         #更新总阅读数，总点赞数

        update ebook_snapshot t1,ebook t2
        set t1.view_count=t2.view_count,t1.vote_count=t2.vote_count
        where t1.ebook_id=t2.id and t1.date=curdate();

--         #获取昨天数据
        select ebook_id, view_count, vote_count from ebook_snapshot t1
        where t1.date=date_sub(curdate(),interval 1 day);

--         #更新今日新增
        update ebook_snapshot t1 left join (select ebook_id, view_count, vote_count from ebook_snapshot
            where date=date_sub(curdate(),interval 1 day)) t2
        on t1.ebook_id=t2.ebook_id
            set t1.view_increase = (t1.view_count-ifnull(t2.view_count,0)),
                t1.vote_increase = (t1.vote_count-ifnull(t2.vote_count,0))
        where t1.date=curdate();
    </update>

</mapper>